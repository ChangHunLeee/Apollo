<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.apollo.task.dao.TaskDAO">

    <select id="getTasks" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from task where pid = #{pid}
    </select>
    
    <select id="getAssignedTasks" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from task where pid=#{pid} and tid in (select tid from assignee)
    </select>
	    
    <select id="getNotAssignedTasks" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from task where pid=#{pid} and tid not in (select tid from assignee)
    </select>
    
    <select id="getTasksInSteps" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    select * from taskinstep where sid = #{sid}
    </select>

    <select id="getTasksByStepId"  resultType="com.apollo.vo.TaskDTO">
    select t.*, s.tstatus, s.color 
    from task t join tstatus s on t.tstatusid = s.tstatusid 
    where tid in (select tid from taskinstep where sid= #{sid})
    </select>
    
    <update id="updateTask" parameterType="com.apollo.vo.TaskDTO">
    	update task set
      <if test="tname != null">tname=#{tname},</if>
      <if test="sday != null">sday=TO_DATE(#{sday},'YYYY-MM-DD HH24:MI:SS'),</if>
      <if test="eday != null">eday=TO_DATE(#{eday},'YYYY-MM-DD HH24:MI:SS'),</if>
      <if test="detail != null">detail=#{detail},</if>
      <if test="importance != 0">importance=#{importance},</if>
      <if test="tstatusid != 0">tstatusid=#{tstatusid},</if>
     	ctime=TO_DATE(sysdate,'YYYY-MM-DD HH24:MI:SS')
    	where tid= #{tid}
    </update>
    
    <select id="getTask" parameterType="String" resultType="com.apollo.vo.TaskDTO">
    	select * from task where tid = #{tid}
    </select>
    
    <insert id="addStar" parameterType="com.apollo.vo.StarredTaskDTO">
    	insert into starredtask values(#{mid}, #{tid})
    </insert>
    
    <delete id="deleteStar" parameterType="com.apollo.vo.StarredTaskDTO">
    	delete from starredtask where mid = #{mid} and tid = #{tid}
    </delete>
    
    <delete id="deleteTask">
    	delete from task where tid = #{tid}
    </delete>
    
    <delete id="deleteStepInTaskModal" parameterType="com.apollo.vo.TaskInStepDTO">
    	delete from taskinstep where sid = #{sid} and tid = #{tid}
    </delete>
	
	<select id="countTaskInStep" resultType="Integer">
		select count(*) from taskinstep where tid = #{tid}
	</select>    
	
	<update id="changeTstatus" parameterType="com.apollo.vo.TidvalueDTO">
		update task set tstatusid = #{value} where tid = #{tid}
	</update>
	
	<insert id="insertComment" parameterType="com.apollo.vo.CommentDTO">
		insert into comments values(seq_cmtid.nextval, #{comments}, #{tid}, #{mid}, #{cmtkind}, TO_DATE(sysdate,'YYYY-MM-DD HH24:MI:SS'))
	</insert>
	
	<select id="getTaskModifierName" parameterType="String" resultType="String">
		select mname from member where mid = #{mid}
	</select>   
	
    <select id="getStepListByTid" parameterType="Integer" resultType="com.apollo.vo.StepDTO">
		select * from step where pid = (select pid from task where tid = #{tid}) and sid not in (select sid from taskinstep where tid = #{tid})
	</select>   
    
    <insert id="addTaskInStepInTaskModal" parameterType="com.apollo.vo.TaskInStepDTO">
		insert into taskinstep values(#{sid}, #{tid})
	</insert>
	
	<select id="getStepNamesbytid" parameterType="Integer" resultType="com.apollo.vo.StepDTO">
		select * from step where sid in (select sid from taskinstep where tid = #{tid})
	</select>  
    
</mapper>
